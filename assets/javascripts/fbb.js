var EXAMPLE_WEATHER_RESPONSE = {"message":"","cod":"200","city_id":5809844,"calctime":0.0031,"cnt":21,"list":[{"weather":[{"id":804,"main":"Clouds","description":"overcast clouds","icon":"04n"}],"main":{"temp":286.54,"pressure":1021,"humidity":71,"temp_min":284.15,"temp_max":289.26},"wind":{"speed":2.1,"deg":0},"forecast_rain":{"3h":0.05},"clouds":{"all":90},"dt":1349247600},{"weather":[{"id":804,"main":"Clouds","description":"overcast clouds","icon":"04n"}],"main":{"temp":286.16,"pressure":1021,"humidity":67,"temp_min":284.15,"temp_max":289.15},"wind":{"speed":2.1,"deg":0},"forecast_rain":{"3h":0.05},"clouds":{"all":90},"dt":1349251200},{"weather":[{"id":803,"main":"Clouds","description":"broken clouds","icon":"04n"}],"main":{"temp":285.31,"pressure":1022,"humidity":71,"temp_min":283.15,"temp_max":288.15},"wind":{"speed":0,"deg":0},"forecast_rain":{"3h":0.05},"clouds":{"all":75},"dt":1349254800},{"weather":[{"id":804,"main":"Clouds","description":"overcast clouds","icon":"04n"}],"main":{"temp":284.3,"pressure":1022,"humidity":76,"temp_min":281.15,"temp_max":286.15},"wind":{"speed":0,"deg":0},"forecast_rain":{"3h":0.05},"clouds":{"all":90},"dt":1349258400},{"weather":[{"id":802,"main":"Clouds","description":"scattered clouds","icon":"03n"}],"main":{"temp":283.96,"pressure":1023,"humidity":87,"temp_min":281.15,"temp_max":286.15},"wind":{"speed":0,"deg":0},"forecast_rain":{"3h":0.05},"clouds":{"all":40},"dt":1349262000},{"weather":[{"id":804,"main":"Clouds","description":"overcast clouds","icon":"04n"}],"main":{"temp":283.23,"pressure":1024,"humidity":81,"temp_min":280.93,"temp_max":286.15},"wind":{"speed":0,"deg":0},"clouds":{"all":90},"dt":1349269200},{"weather":[{"id":800,"main":"Clear","description":"sky is clear","icon":"02d"}],"main":{"temp":283.5,"humidity":67,"pressure":1042,"temp_min":281.48,"temp_max":285.37},"wind":{"speed":6.68,"gust":8.22,"deg":180},"clouds":{"all":15},"dt":1349272800},{"weather":[{"id":800,"main":"Clear","description":"sky is clear","icon":"02d"}],"main":{"temp":286.71,"humidity":42,"pressure":1043,"temp_min":283.71,"temp_max":290.37},"wind":{"speed":1.03,"gust":4.11,"deg":180},"clouds":{"all":15},"dt":1349283600},{"weather":[{"id":800,"main":"Clear","description":"sky is clear","icon":"02d"}],"main":{"temp":287.42,"humidity":39,"pressure":1043,"temp_min":285.15,"temp_max":290.93},"wind":{"speed":1.54,"gust":3.08,"deg":180},"clouds":{"all":5},"dt":1349287200},{"weather":[{"id":800,"main":"Clear","description":"sky is clear","icon":"02d"}],"main":{"temp":288.61,"humidity":34,"pressure":1043,"temp_min":286.15,"temp_max":293.71},"wind":{"speed":1.03,"gust":2.06,"deg":180},"clouds":{"all":5},"dt":1349290800},{"weather":[{"id":800,"main":"Clear","description":"sky is clear","icon":"02d"}],"main":{"temp":289.13,"humidity":32,"pressure":1043,"temp_min":286.48,"temp_max":293.71},"wind":{"speed":1.03,"gust":2.57,"deg":180},"clouds":{"all":5},"dt":1349294400},{"weather":[{"id":800,"main":"Clear","description":"sky is clear","icon":"02d"}],"main":{"temp":289.41,"humidity":33,"pressure":1042,"temp_min":287.04,"temp_max":293.71},"wind":{"speed":1.54,"gust":3.6,"deg":180},"clouds":{"all":5},"dt":1349298000},{"weather":[{"id":800,"main":"Clear","description":"sky is clear","icon":"01d"}],"main":{"temp":288.95,"pressure":1022,"humidity":33,"temp_min":287.04,"temp_max":291.15},"wind":{"speed":3.6,"deg":290},"clouds":{"all":1},"dt":1349305200},{"weather":[{"id":804,"main":"Clouds","description":"overcast clouds","icon":"04n"}],"main":{"temp":288.79,"pressure":1024,"humidity":41,"temp_min":287.04,"temp_max":291.15},"wind":{"speed":2.6,"deg":340},"clouds":{"all":90},"dt":1349308800},{"weather":[{"id":800,"main":"Clear","description":"sky is clear","icon":"01n"}],"main":{"temp":287.47,"pressure":1022,"humidity":38,"temp_min":285.37,"temp_max":289.15},"wind":{"speed":2.6,"deg":0},"clouds":{"all":1},"dt":1349312400},{"weather":[{"id":800,"main":"Clear","description":"sky is clear","icon":"01n"}],"main":{"temp":286.01,"pressure":1023,"humidity":47,"temp_min":283.71,"temp_max":288.15},"wind":{"speed":4.1,"deg":330},"clouds":{"all":1},"dt":1349316000},{"weather":[{"id":800,"main":"Clear","description":"sky is clear","icon":"01n"}],"main":{"temp":284.85,"pressure":1023,"humidity":50,"temp_min":282.59,"temp_max":288.15},"wind":{"speed":2.6,"deg":350},"clouds":{"all":1},"dt":1349319600},{"weather":[{"id":800,"main":"Clear","description":"sky is clear","icon":"01n"}],"main":{"temp":283.91,"pressure":1024,"humidity":58,"temp_min":282.04,"temp_max":286.15},"wind":{"speed":1.5,"deg":360},"clouds":{"all":1},"dt":1349323200},{"weather":[{"id":800,"main":"Clear","description":"sky is clear","icon":"01n"}],"main":{"temp":283.31,"pressure":1024,"humidity":58,"temp_min":280.93,"temp_max":286.15},"wind":{"speed":0,"deg":0},"clouds":{"all":1},"dt":1349326800},{"weather":[{"id":800,"main":"Clear","description":"sky is clear","icon":"01n"}],"main":{"temp":283.07,"pressure":1025,"humidity":58,"temp_min":280.37,"temp_max":285.15},"wind":{"speed":1.5,"deg":20},"clouds":{"all":1},"dt":1349330400},{"weather":[{"id":800,"main":"Clear","description":"sky is clear","icon":"01n"}],"main":{"temp":283.15,"pressure":1026,"humidity":40,"temp_min":280.37,"temp_max":285.15},"wind":{"speed":8.2,"deg":360,"gust":12.9},"clouds":{"all":1},"dt":1349334000}]}
var EXAMPLE_BIKE_RESPONSE = [ { "fremont_bridge_nb" : "4", "fremont_bridge_sb" : "9", "date" : "2012-10-03T00:00:00" }, { "fremont_bridge_nb" : "4", "fremont_bridge_sb" : "6", "date" : "2012-10-03T01:00:00" }, { "fremont_bridge_nb" : "1", "fremont_bridge_sb" : "1", "date" : "2012-10-03T02:00:00" }, { "fremont_bridge_nb" : "2", "fremont_bridge_sb" : "3", "date" : "2012-10-03T03:00:00" }, { "fremont_bridge_nb" : "6", "fremont_bridge_sb" : "1", "date" : "2012-10-03T04:00:00" }, { "fremont_bridge_nb" : "21", "fremont_bridge_sb" : "10", "date" : "2012-10-03T05:00:00" }, { "fremont_bridge_nb" : "105", "fremont_bridge_sb" : "50", "date" : "2012-10-03T06:00:00" }, { "fremont_bridge_nb" : "257", "fremont_bridge_sb" : "95", "date" : "2012-10-03T07:00:00" }, { "fremont_bridge_nb" : "291", "fremont_bridge_sb" : "146", "date" : "2012-10-03T08:00:00" }, { "fremont_bridge_nb" : "172", "fremont_bridge_sb" : "104", "date" : "2012-10-03T09:00:00" }, { "fremont_bridge_nb" : "72", "fremont_bridge_sb" : "46", "date" : "2012-10-03T10:00:00" }, { "fremont_bridge_nb" : "10", "fremont_bridge_sb" : "32", "date" : "2012-10-03T11:00:00" }, { "fremont_bridge_nb" : "35", "fremont_bridge_sb" : "41", "date" : "2012-10-03T12:00:00" }, { "fremont_bridge_nb" : "42", "fremont_bridge_sb" : "48", "date" : "2012-10-03T13:00:00" }, { "fremont_bridge_nb" : "77", "fremont_bridge_sb" : "51", "date" : "2012-10-03T14:00:00" }, { "fremont_bridge_nb" : "72", "fremont_bridge_sb" : "92", "date" : "2012-10-03T15:00:00" }, { "fremont_bridge_nb" : "133", "fremont_bridge_sb" : "182", "date" : "2012-10-03T16:00:00" }, { "fremont_bridge_nb" : "192", "fremont_bridge_sb" : "391", "date" : "2012-10-03T17:00:00" }, { "fremont_bridge_nb" : "122", "fremont_bridge_sb" : "258", "date" : "2012-10-03T18:00:00" }, { "fremont_bridge_nb" : "59", "fremont_bridge_sb" : "69", "date" : "2012-10-03T19:00:00" }, { "fremont_bridge_nb" : "29", "fremont_bridge_sb" : "51", "date" : "2012-10-03T20:00:00" }, { "fremont_bridge_nb" : "25", "fremont_bridge_sb" : "38", "date" : "2012-10-03T21:00:00" }, { "fremont_bridge_nb" : "24", "fremont_bridge_sb" : "25", "date" : "2012-10-03T22:00:00" }, { "fremont_bridge_nb" : "5", "fremont_bridge_sb" : "12", "date" : "2012-10-03T23:00:00" } ];

var HOUR_LENGTH = 3000;
var defaultStartDate = '2012-10-03';
var bikeScale = 10;

var timeHandler; // TODO: does this NEED to be a global variable?
var bikeRepository; // TODO: does this NEED to be a global variable?
var weatherRepository; // TODO: does this NEED to be a global variable?

var timeouts = [];

window.FBB = {};

$(document).ready(function() {
  FBB.initializeView();

  $('input[type=date]').change( function () {
    var dateElements = $(this).val().split('-');
    var date = new Date(dateElements[0], dateElements[1] - 1, dateElements[2]);

    FBB.display(date);
  });

  $('.timescale').change( function() {
    HOUR_LENGTH = $(this).val() * 1000;
  });

  $('.bikescale').change( function() {
    bikeScale = $(this).val();
  });
});

FBB.initializeView = function() {
  timeHandler = new TimeHandler;
  bikeRepository = new BikeRepository;
  weatherRepository = new WeatherRepository;

  $('input').attr('value', defaultStartDate);
  $('.bikescale').attr('value', bikeScale);
  FBB.display(new Date(2012, 9, 03)); // Date uses a 0-based index for month
}

FBB.display = function(date) {
  $('.timescale').attr('value', HOUR_LENGTH/1000);
  FBB.clearTimeouts();
  FBB.clearBikes();

  bikeRepository.fetch(date, FBB.triggerDisplay);
  weatherRepository.fetch(date, FBB.triggerDisplay);
}

FBB.triggerDisplay = function(date, iterator) {
  if (!(weatherRepository.data[date] && bikeRepository.data[date])) { return; }

  timeHandler.update(date, iterator);
  bikeRepository.update(date, iterator);
  weatherRepository.update(date, iterator);

  if (iterator < 23) {
    timeouts.push(setTimeout(FBB.triggerDisplay, HOUR_LENGTH, date, iterator + 1));
  } else {
    // replay button? go on to the next day? (would need to confirm that there's data)
  }
}

FBB.clearTimeouts = function() {
  for (var i = 0; i < timeouts.length; i++) {
    clearTimeout(timeouts[i]);
  }
}

FBB.clearBikes = function() {
  var bikes = $('.bike-small');
  for (var i = 0; i < bikes.length; i++) {
    bikes[i].remove();
  }
}

// TODO: add a check to see if there's data / if it's a valid option
